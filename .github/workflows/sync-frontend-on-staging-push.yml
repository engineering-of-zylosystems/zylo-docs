# ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„
name: Sync Frontend on Staging Push

# ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë  ì¡°ê±´ ì •ì˜
on:
  push:
    branches:
      - staging # staging ë¸Œëœì¹˜ì— í‘¸ì‹œê°€ ë°œìƒí•  ë•Œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

permissions:
  contents: write

# ì›Œí¬í”Œë¡œìš°ì—ì„œ ì‹¤í–‰ë  ì‘ì—…(jobs) ì •ì˜
jobs:
  sync_frontend:
    # ì´ ì‘ì—…ì´ ì‹¤í–‰ë  í™˜ê²½ì„ ì§€ì •í•©ë‹ˆë‹¤.
    runs-on: ubuntu-latest

    # ì‘ì—…ì˜ ë‹¨ê³„(steps) ì •ì˜
    steps:
      # 1. ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4 # ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        with:
          # Git í‘¸ì‹œë¥¼ ìœ„í•´ í† í° ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
          # ì´ í† í°ì€ ì›Œí¬í”Œë¡œìš°ê°€ ì €ì¥ì†Œì— ë³€ê²½ ì‚¬í•­ì„ í‘¸ì‹œí•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. AWS ìê²© ì¦ëª… ì„¤ì •
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4 # AWS ìê²© ì¦ëª…ì„ ì„¤ì •í•˜ëŠ” GitHub Actionì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        with:
          # GitHub Secretsì— ì €ì¥ëœ AWS Access Key IDë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          # GitHub Secretsì— ì €ì¥ëœ AWS Secret Access Keyë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # AWS ë¦¬ì „ì„ ì§€ì •í•©ë‹ˆë‹¤. (ì˜ˆ: ap-northeast-2ëŠ” ì„œìš¸ ë¦¬ì „)
          aws-region: ap-northeast-2

      # 3. S3ì—ì„œ í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      - name: Download Frontend Build Files from S3
        run: |
          #!/bin/bash
          set -e # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œí•©ë‹ˆë‹¤.

          S3_PATH="s3://zylo-docs-lib-fe/docs/" # S3 ë²„í‚· ê²½ë¡œë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
          DEST_DIR="zylo_docs/static" # íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•  ë¡œì»¬ ë””ë ‰í† ë¦¬ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

          # S3 ë²„í‚·ì— ì ‘ê·¼ ê°€ëŠ¥í•œì§€ í™•ì¸í•©ë‹ˆë‹¤.
          echo "ğŸ” S3 ë²„í‚· ì ‘ê·¼ ê°€ëŠ¥í•œì§€ í™•ì¸ ì¤‘..."
          if ! aws s3 ls "$S3_PATH" > /dev/null; then
            echo "âŒ S3 ê²½ë¡œ ì ‘ê·¼ ì‹¤íŒ¨: $S3_PATH"
            echo "ğŸ”’ ê¶Œí•œ ë˜ëŠ” ê²½ë¡œê°€ ì˜ëª»ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            exit 1 # ì ‘ê·¼ ì‹¤íŒ¨ ì‹œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
          fi

          # ëŒ€ìƒ ë””ë ‰í† ë¦¬ë¥¼ ì •ë¦¬í•˜ê³  ìƒì„±í•©ë‹ˆë‹¤.
          echo "ğŸ§¹ Cleaning $DEST_DIR directory..."
          mkdir -p "$DEST_DIR" # ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±í•©ë‹ˆë‹¤.
          rm -rf "${DEST_DIR:?}"/* # ê¸°ì¡´ íŒŒì¼ì„ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤. (DEST_DIRì´ ë¹„ì–´ìˆì§€ ì•Šë„ë¡ ì£¼ì˜)

          # S3ì—ì„œ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
          echo "ğŸ“¥ Downloading files from $S3_PATH"
          aws s3 cp "$S3_PATH" "$DEST_DIR/" --recursive # S3 ê²½ë¡œì˜ ëª¨ë“  íŒŒì¼ì„ ëŒ€ìƒ ë””ë ‰í† ë¦¬ë¡œ ì¬ê·€ì ìœ¼ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤.

          echo "âœ… Done! Files downloaded to $DEST_DIR"

      # 4. ë³€ê²½ëœ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ì„ Gitì— ì»¤ë°‹í•˜ê³  í‘¸ì‹œ (ìƒˆë¡œìš´ ë‹¨ê³„)
      - name: Commit and Push Frontend Files
        run: |
          # Git ì‚¬ìš©ì ì •ë³´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com

          # ë³€ê²½ëœ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ìŠ¤í…Œì´ì§•í•©ë‹ˆë‹¤.
          # zylo_docs/static ë””ë ‰í† ë¦¬ì˜ ëª¨ë“  ë³€ê²½ ì‚¬í•­ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
          git add zylo_docs/static/*

          # ë³€ê²½ëœ íŒŒì¼ì´ ìˆë‹¤ë©´ ì»¤ë°‹í•©ë‹ˆë‹¤.
          # "[skip ci]" ë˜ëŠ” "[skip actions]"ë¥¼ ì»¤ë°‹ ë©”ì‹œì§€ì— í¬í•¨í•˜ì—¬
          # ì´ í‘¸ì‹œê°€ ë‹¤ì‹œ ì›Œí¬í”Œë¡œìš°ë¥¼ íŠ¸ë¦¬ê±°í•˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
          git commit -m "Sync frontend build files from S3 [skip ci]" || echo "No changes to commit"

          # ë³€ê²½ ì‚¬í•­ì„ staging ë¸Œëœì¹˜ë¡œ í‘¸ì‹œí•©ë‹ˆë‹¤.
          # í˜„ì¬ ë¸Œëœì¹˜(staging)ë¡œ í‘¸ì‹œí•©ë‹ˆë‹¤.
          git push origin HEAD

      - name: Install Poetry and Twine
        run: pip install poetry twine

      - name: Update package name to zylib-test for staging
        run: |
          echo "ğŸ›  Changing package name in pyproject.toml to 'zylib-test'"
          sed -i 's/^name = "zylo-docs"/name = "zylib-test"/' pyproject.toml

      - name: Build and Publish to Test PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          set -e
          echo "ğŸ”§ Bumping version"
          poetry version patch
          echo "ğŸ”¨ Building package"
          poetry build
          echo "ğŸš€ Uploading to Test PyPI"
          twine upload --repository-url https://test.pypi.org/legacy/ dist/*
