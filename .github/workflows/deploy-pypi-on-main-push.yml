name: Deploy PyPI on Main Push

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry and Twine
        run: |
          pip install poetry twine

      - name: Update package name to zylo-docs for staging
        run: |
          echo "ðŸ›  Changing package name in pyproject.toml to 'zylo-docs'"
          sed -i 's/^name = "zylib-test"/name = "zylo-docs"/' pyproject.toml

      - name: Calculate Next Version from Git Tags
        id: get_version
        run: |
          echo "ðŸ”„ Calculating next version from Git tags..."
          git fetch --tags
          # Get the latest tag, sort them by version number
          LATEST_TAG=$(git tag --sort=-v:refname | head -n 1)

          if [ -z "$LATEST_TAG" ]; then
            echo "No tags found. Starting with version 0.0.1."
            NEXT_VERSION="0.0.1"
          else
            echo "Latest tag is $LATEST_TAG"
            # Remove 'v' prefix if it exists
            VERSION=${LATEST_TAG#v}
            # Split version into parts
            IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
            # Increment patch version
            VERSION_PARTS[2]=$((VERSION_PARTS[2] + 1))
            NEXT_VERSION="${VERSION_PARTS[0]}.${VERSION_PARTS[1]}.${VERSION_PARTS[2]}"
          fi

          echo "Calculated next version: $NEXT_VERSION"
          echo "::set-output name=version::$NEXT_VERSION"

      - name: Deploy to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          set -e

          echo "--- ê¸°ì¡´ dist ì‚­ì œ ---"
          rm -rf ./dist

          echo "--- Git ì„¤ì • ---"
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com

          echo "--- ë²„ì „ ì˜¬ë¦¬ê¸° ---"
          VERSION=${{ steps.get_version.outputs.version }}
          poetry version $VERSION
          echo "âž¡ï¸ ìƒˆ ë²„ì „: $VERSION"

          echo "--- ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ---"
          git add pyproject.toml
          if [ -f poetry.lock ]; then
            git add poetry.lock
          fi
          git commit -m "ðŸ”– Bump version to $VERSION for PyPI release [skip ci]" || echo "No changes to commit"

          echo "--- ìƒˆ íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ ---"
          git tag "v$VERSION"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main --tags

          echo "--- ë¹Œë“œ ---"
          poetry build

          echo "--- PyPI ì—…ë¡œë“œ ---"
          twine upload dist/*

          echo "âœ… ë°°í¬ ì™„ë£Œ!"
