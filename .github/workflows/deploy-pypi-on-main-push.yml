name: Deploy PyPI on Main Push

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry and Twine
        run: |
          pip install poetry twine

      - name: Update package name to zylo-docs for staging
        run: |
          echo "ğŸ›  Changing package name in pyproject.toml to 'zylo-docs'"
          sed -i 's/^name = "zylib-test"/name = "zylo-docs"/' pyproject.toml

      - name: Restore Main Branch Version
        id: get_version
        run: |
          echo "ğŸ”„ Restoring version from main branch before bumping..."
          # Extracts the version from the pyproject.toml of the commit before the merge/push on main
          MAIN_BRANCH_VERSION=$(git show HEAD~1:pyproject.toml | grep 'version = ' | awk -F '"' '{print $2}')
          echo "Found version $MAIN_BRANCH_VERSION on main branch."
          # Sets the current pyproject.toml to that old version
          poetry version $MAIN_BRANCH_VERSION
          echo "âœ… Version restored to $MAIN_BRANCH_VERSION."

      - name: Deploy to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          set -e

          echo "--- ê¸°ì¡´ dist ì‚­ì œ ---"
          rm -rf ./dist

          echo "--- Git ì„¤ì • ---"
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com

          echo "--- ë²„ì „ ì˜¬ë¦¬ê¸° ---"
          poetry version patch
          VERSION=$(poetry version -s)
          echo "â¡ï¸ ìƒˆ ë²„ì „: $VERSION"

          echo "--- ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ---"
          # pyproject.toml ë° poetry.lock ë³€ê²½ì‚¬í•­ì„ ì»¤ë°‹í•©ë‹ˆë‹¤.
          git add pyproject.toml
          if [ -f poetry.lock ]; then
            git add poetry.lock
          fi
          git commit -m "ğŸ”– Bump version to $VERSION for PyPI release [skip ci]" || echo "No changes to commit"

          echo "--- ì»¤ë°‹ í‘¸ì‹œ ---"
          # GITHUB_TOKENì„ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ë¸Œëœì¹˜(main)ë¡œ í‘¸ì‹œí•©ë‹ˆë‹¤.
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:main

          echo "--- ë¹Œë“œ ---"
          poetry build

          echo "--- PyPI ì—…ë¡œë“œ ---"
          twine upload dist/*

          echo "âœ… ë°°í¬ ì™„ë£Œ!"
